<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>60 Hizbs du Coran</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìñ</text></svg>">
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Amiri', serif; margin: 0; padding: 20px; background: #f5f5f5 url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><path d="M50 5 L95 95 L5 95 Z" fill="none" stroke="#2196f3" stroke-width="2"/></svg>') repeat; color: #212121; }
        #progress { margin-bottom: 20px; text-align: center; }
        #progress-circle { width: 100px; height: 100px; margin: 0 auto; }
        select, input { width: 100%; padding: 12px; font-size: 18px; border: 1px solid #64b5f6; border-radius: 8px; background: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; }
        #content { direction: rtl; white-space: pre-wrap; line-height: 1.8; background: #ffffff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: font-size 0.3s; }
        .surah-title { font-size: 24px; color: #1976d2; text-align: center; margin: 20px 0 10px; border-bottom: 1px solid #bbdefb; padding-bottom: 5px; }
        button { padding: 12px 24px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s, transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 5px; }
        button:hover { background: #1e88e5; transform: translateY(-2px); }
        button.undo { background: #e57373; }
        button.reset { background: #42a5f5; }
        #font-size { display: flex; align-items: center; }
        #font-slider { flex: 1; margin-left: 10px; }
        #favorites, #history { margin-top: 20px; }
        .favorite { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="progress">
        Progression: <span id="count">0/60</span> (<span id="percent">0%</span>)
        <svg id="progress-circle" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="none" stroke="#bbdefb" stroke-width="10"/>
            <circle cx="50" cy="50" r="45" fill="none" stroke="#2196f3" stroke-width="10" stroke-dasharray="283" stroke-dashoffset="283" id="progress-ring"/>
        </svg>
    </div>
    <select id="hizbSelect" onchange="loadHizb(this.value)">
        <option value="">S√©lectionnez un Hizb</option>
    </select>
    <select id="surahSelect" onchange="loadSurah(this.value)">
        <option value="">Navigation par Surah</option>
    </select>
    <input type="text" id="search" placeholder="Recherche texte" oninput="searchText(this.value)">
    <div id="font-size">Taille texte: <input type="range" id="font-slider" min="12" max="30" value="22" oninput="adjustFont(this.value)"></div>
    <div id="content"></div>
    <button class="reset" onclick="resetProgress()">R√©initialiser</button>
    <div id="favorites"></div>
    <div id="history"></div>

    <script>
        const hizbRanges = [/* insert hizbRanges array */];
        const surahNames = [/* insert surahNames array */];
        let quranData = JSON.parse(localStorage.getItem('quranData')) || null;
        let readHizbs = JSON.parse(localStorage.getItem('hizbsRead')) || [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];

        async function loadQuran() {
            if (!quranData) {
                const response = await fetch('https://api.alquran.cloud/v1/quran/quran-uthmani');
                quranData = await response.json();
                localStorage.setItem('quranData', JSON.stringify(quranData));
            }
        }

        function updateProgress() {
            const count = readHizbs.length;
            const percent = (count / 60 * 100).toFixed(0);
            document.getElementById('count').textContent = `${count}/60`;
            document.getElementById('percent').textContent = `${percent}%`;
            document.getElementById('progress-ring').style.strokeDashoffset = 283 - (283 * percent / 100);
        }

        function renderSelects() {
            const hizbSelect = document.getElementById('hizbSelect');
            hizbSelect.innerHTML = '<option value="">S√©lectionnez un Hizb</option>';
            for (let i = 1; i <= 60; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Hizb ${i}${readHizbs.includes(i) ? ' ‚úî' : ''}`;
                hizbSelect.appendChild(option);
            }
            const surahSelect = document.getElementById('surahSelect');
            surahSelect.innerHTML = '<option value="">Navigation par Surah</option>';
            surahNames.forEach((name, i) => {
                if (i > 0) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = name;
                    surahSelect.appendChild(option);
                }
            });
        }

        async function loadHizb(hizbNum) {
            await loadQuran();
            if (!hizbNum) return;
            addToHistory(`Hizb ${hizbNum}`);
            const isRead = readHizbs.includes(parseInt(hizbNum));
            const range = hizbRanges[hizbNum - 1];
            let text = '';
            let currentSurah = 0;
            for (const part of range.parts) {
                if (part.surah !== currentSurah) {
                    text += `<div class="surah-title">ÿ≥Ÿàÿ±ÿ© ${surahNames[part.surah]}</div>`;
                    currentSurah = part.surah;
                }
                const ayahs = quranData.data.surahs[part.surah - 1].ayahs;
                for (let a = part.start - 1; a < part.end; a++) {
                    text += ayahs[a].text + ' €ù ';
                }
            }
            const content = document.getElementById('content');
            let buttons = '<br><button onclick="markDone(' + hizbNum + ')">Termin√© ‚úî</button>';
            if (isRead) buttons += ' <button class="undo" onclick="unmarkDone(' + hizbNum + ')">Annuler ‚úñ</button>';
            content.innerHTML = text + buttons + '<br><button onclick="addFavorite(\'Hizb ' + hizbNum + '\')">Favori ‚≠ê</button>';
            content.style.opacity = 0; setTimeout(() => content.style.opacity = 1, 100);
            content.scrollIntoView({behavior: 'smooth'});
        }

        async function loadSurah(surahNum) {
            await loadQuran();
            if (!surahNum) return;
            addToHistory(`Surah ${surahNames[surahNum]}`);
            const surah = quranData.data.surahs[surahNum - 1];
            let text = `<div class="surah-title">ÿ≥Ÿàÿ±ÿ© ${surahNames[surahNum]}</div>`;
            surah.ayahs.forEach(ayah => text += ayah.text + ' €ù ');
            const content = document.getElementById('content');
            content.innerHTML = text + '<br><button onclick="addFavorite(\'Surah ' + surahNum + '\')">Favori ‚≠ê</button>';
            content.scrollIntoView({behavior: 'smooth'});
        }

        function searchText(query) {
            if (!query) return;
            const content = document.getElementById('content');
            content.innerHTML = '';
            quranData.data.surahs.forEach(surah => {
                surah.ayahs.forEach(ayah => {
                    if (ayah.text.includes(query)) {
                        content.innerHTML += `<div class="favorite">${surahNames[surah.number]} Ayah ${ayah.numberInSurah}: ${ayah.text}</div>`;
                    }
                });
            });
        }

        function adjustFont(size) {
            document.getElementById('content').style.fontSize = `${size}px`;
        }

        function markDone(hizbNum) {
            if (!readHizbs.includes(hizbNum)) {
                readHizbs.push(hizbNum);
                localStorage.setItem('hizbsRead', JSON.stringify(readHizbs));
                updateProgress();
                renderSelects();
                document.getElementById('content').innerHTML = '';
            }
        }

        function unmarkDone(hizbNum) {
            readHizbs = readHizbs.filter(h => h !== hizbNum);
            localStorage.setItem('hizbsRead', JSON.stringify(readHizbs));
            updateProgress();
            renderSelects();
            document.getElementById('content').innerHTML = '';
        }

        function resetProgress() {
            if (confirm('R√©initialiser ?')) {
                readHizbs = [];
                localStorage.setItem('hizbsRead', JSON.stringify(readHizbs));
                updateProgress();
                renderSelects();
                document.getElementById('content').innerHTML = '';
            }
        }

        function addFavorite(item) {
            if (!favorites.includes(item)) favorites.push(item);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderFavorites();
        }

        function renderFavorites() {
            const favDiv = document.getElementById('favorites');
            favDiv.innerHTML = '<h3>Favoris</h3>';
            favorites.forEach(fav => favDiv.innerHTML += `<div class="favorite">${fav}</div>`);
        }

        function addToHistory(item) {
            history.unshift(item);
            if (history.length > 5) history.pop();
            localStorage.setItem('history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const histDiv = document.getElementById('history');
            histDiv.innerHTML = '<h3>Historique</h3>';
            history.forEach(hist => histDiv.innerHTML += `<div class="favorite">${hist}</div>`);
        }

        loadQuran().then(() => {
            renderSelects();
            updateProgress();
            renderFavorites();
            renderHistory();
            adjustFont(22);
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js');
            }
        });
    </script>
</body>
</html>
