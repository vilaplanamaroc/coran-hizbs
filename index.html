<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>60 Hizbs du Coran</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìñ</text></svg>">
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Amiri', serif; margin: 0; padding: 20px; background: #f5f5f5 url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><path d="M50 5 L95 95 L5 95 Z" fill="none" stroke="#2196f3" stroke-width="2"/></svg>') repeat; color: #212121; }
        #progress { margin-bottom: 20px; text-align: center; }
        #progress-circle { width: 100px; height: 100px; margin: 0 auto; }
        select, input { width: 100%; padding: 12px; font-size: 18px; border: 1px solid #64b5f6; border-radius: 8px; background: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; }
        #content { direction: rtl; white-space: pre-wrap; line-height: 1.8; background: #ffffff; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: font-size 0.3s, opacity 0.3s; opacity: 0; }
        #content.loaded { opacity: 1; }
        .surah-title { font-size: 24px; color: #1976d2; text-align: center; margin: 20px 0 10px; border-bottom: 1px solid #bbdefb; padding-bottom: 5px; }
        button { padding: 12px 24px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s, transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 5px; }
        button:hover { background: #1e88e5; transform: translateY(-2px); }
        button.undo { background: #e57373; }
        button.reset { background: #42a5f5; }
        #font-size { display: flex; align-items: center; }
        #font-slider { flex: 1; margin-left: 10px; }
        #favorites, #history { margin-top: 20px; }
        .favorite { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 10px; cursor: pointer; }
        #loading { text-align: center; margin-top: 20px; font-style: italic; color: #757575; }
    </style>
</head>
<body>
    <div id="progress">
        Progression: <span id="count">0/60</span> (<span id="percent">0%</span>)
        <svg id="progress-circle" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="none" stroke="#bbdefb" stroke-width="10"/>
            <circle cx="50" cy="50" r="45" fill="none" stroke="#2196f3" stroke-width="10" stroke-dasharray="283" stroke-dashoffset="283" id="progress-ring"/>
        </svg>
    </div>
    <select id="hizbSelect" onchange="loadHizb(this.value)">
        <option value="">S√©lectionnez un Hizb</option>
    </select>
    <select id="surahSelect" onchange="loadSurah(this.value)">
        <option value="">Navigation par Surah</option>
    </select>
    <input type="text" id="search" placeholder="Recherche texte" oninput="searchText(this.value)">
    <div id="font-size">Taille texte: <input type="range" id="font-slider" min="12" max="30" value="22" oninput="adjustFont(this.value)"></div>
    <div id="loading" style="display:none;">Chargement...</div>
    <div id="content"></div>
    <button class="reset" onclick="resetProgress()">R√©initialiser</button>
    <div id="favorites"><h3>Favoris</h3></div>
    <div id="history"><h3>Historique</h3></div>

    <script>
        const hizbRanges = [
            {hizb:1, parts:[{surah:1,start:1,end:7},{surah:2,start:1,end:74}]},
            // ... (ajoutez le reste du tableau hizbRanges ici)
            {hizb:60, parts:[{surah:87,start:1,end:19},{surah:88,start:1,end:26},{surah:89,start:1,end:30},{surah:90,start:1,end:20},{surah:91,start:1,end:15},{surah:92,start:1,end:21},{surah:93,start:1,end:11},{surah:94,start:1,end:8},{surah:95,start:1,end:8},{surah:96,start:1,end:19},{surah:97,start:1,end:5},{surah:98,start:1,end:8},{surah:99,start:1,end:8},{surah:100,start:1,end:11},{surah:101,start:1,end:11},{surah:102,start:1,end:8},{surah:103,start:1,end:3},{surah:104,start:1,end:9},{surah:105,start:1,end:5},{surah:106,start:1,end:4},{surah:107,start:1,end:7},{surah:108,start:1,end:3},{surah:109,start:1,end:6},{surah:110,start:1,end:3},{surah:111,start:1,end:5},{surah:112,start:1,end:4},{surah:113,start:1,end:5},{surah:114,start:1,end:6}]}
        ];

        const surahNames = ['','Al-Fatihah','Al-Baqarah','Ali \'Imran','An-Nisa\'','Al-Ma\'idah','Al-An\'am','Al-A\'raf','Al-Anfal','At-Tawbah','Yunus','Hud','Yusuf','Ar-Ra\'d','Ibrahim','Al-Hijr','An-Nahl','Al-Isra\'','Al-Kahf','Maryam','Taha','Al-Anbiya\'','Al-Hajj','Al-Mu\'minun','An-Nur','Al-Furqan','Ash-Shu\'ara\'','An-Naml','Al-Qasas','Al-\'Ankabut','Ar-Rum','Luqman','As-Sajdah','Al-Ahzab','Saba\'','Fatir','Ya-Sin','As-Saffat','Sad','Az-Zumar','Ghafir','Fussilat','Ash-Shura','Az-Zukhruf','Ad-Dukhan','Al-Jathiyah','Al-Ahqaf','Muhammad','Al-Fath','Al-Hujurat','Qaf','Adh-Dhariyat','At-Tur','An-Najm','Al-Qamar','Ar-Rahman','Al-Waqi\'ah','Al-Hadid','Al-Mujadilah','Al-Hashr','Al-Mumtahanah','As-Saff','Al-Jumu\'ah','Al-Munafiqun','At-Taghabun','At-Talaq','At-Tahrim','Al-Mulk','Al-Qalam','Al-Haqqah','Al-Ma\'arij','Nuh','Al-Jinn','Al-Muzzammil','Al-Muddaththir','Al-Qiyamah','Al-Insan','Al-Mursalat','An-Naba\'','An-Nazi\'at','\'Abasa','At-Takwir','Al-Infitar','Al-Mutaffifin','Al-Inshiqaq','Al-Buruj','At-Tariq','Al-A\'la','Al-Ghashiyah','Al-Fajr','Al-Balad','Ash-Shams','Al-Layl','Ad-Duha','Ash-Sharh','At-Tin','Al-\'Alaq','Al-Qadr','Al-Bayyinah','Az-Zalzalah','Al-\'Adiyat','Al-Qari\'ah','At-Takathur','Al-\'Asr','Al-Humazah','Al-Fil','Quraysh','Al-Ma\'un','Al-Kawthar','Al-Kafirun','An-Nasr','Al-Masad','Al-Ikhlas','Al-Falaq','An-Nas'];

        let quranData = JSON.parse(localStorage.getItem('quranData')) || null;
        let readHizbs = JSON.parse(localStorage.getItem('hizbsRead')) || [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];

        async function loadQuran() {
            document.getElementById('loading').style.display = 'block';
            if (!quranData) {
                try {
                    const response = await fetch('https://api.alquran.cloud/v1/quran/quran-uthmani');
                    quranData = await response.json();
                    localStorage.setItem('quranData', JSON.stringify(quranData));
                } catch (e) {
                    console.error(e);
                }
            }
            document.getElementById('loading').style.display = 'none';
        }

        function updateProgress() {
            const count = readHizbs.length;
            const percent = (count / 60 * 100).toFixed(0);
            document.getElementById('count').textContent = `${count}/60`;
            document.getElementById('percent').textContent = `${percent}%`;
            document.getElementById('progress-ring').style.strokeDashoffset = 283 - (283 * percent / 100);
        }

        function renderSelects() {
            const hizbSelect = document.getElementById('hizbSelect');
            hizbSelect.innerHTML = '<option value="">S√©lectionnez un Hizb</option>';
            for (let i = 1; i <= 60; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Hizb ${i}${readHizbs.includes(i) ? ' ‚úî' : ''}`;
                hizbSelect.appendChild(option);
            }
            const surahSelect = document.getElementById('surahSelect');
            surahSelect.innerHTML = '<option value="">Navigation par Surah</option>';
            surahNames.forEach((name, i) => {
                if (i > 0) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = name;
                    surahSelect.appendChild(option);
                }
            });
        }

        async function loadHizb(hizbNum) {
            await loadQuran();
            if (!hizbNum || !quranData) return;
            addToHistory(`Hizb ${hizbNum}`);
            const isRead = readHizbs.includes(parseInt(hizbNum));
            const range = hizbRanges[hizbNum - 1];
            let text = '';
            let currentSurah = 0;
            for (const part of range.parts) {
                if (part.surah !== currentSurah) {
                    text += `<div class="surah-title">ÿ≥Ÿàÿ±ÿ© ${surahNames[part.surah]}</div>`;
                    currentSurah = part.surah;
                }
                const ayahs = quranData.data.surahs[part.surah - 1].ayahs;
                for (let a = part.start - 1; a < part.end; a++) {
                    text += ayahs[a].text + ' €ù ';
                }
            }
            const content = document.getElementById('content');
            let buttons = '<br><button onclick="markDone(' + hizbNum + ')">Termin√© <span class="icon">‚úî</span></button>';
            if (isRead) buttons += ' <button class="undo" onclick="unmarkDone(' + hizbNum + ')">Annuler <span class="icon">‚úñ</span></button>';
            content.innerHTML = text + buttons + '<br><button onclick="addFavorite(\'Hizb ' + hizbNum + '\')">Ajouter aux Favoris <span class="icon">‚≠ê</span></button>';
            content.classList.add('loaded');
            content.scrollIntoView({behavior: 'smooth'});
        }

        async function loadSurah(surahNum) {
            await loadQuran();
            if (!surahNum || !quranData) return;
            addToHistory(`Surah ${surahNames[surahNum]}`);
            const surah = quranData.data.surahs[surahNum - 1];
            let text = `<div class="surah-title">ÿ≥Ÿàÿ±ÿ© ${surahNames[surahNum]}</div>`;
            surah.ayahs.forEach(ayah => text += ayah.text + ' €ù ');
            const content = document.getElementById('content');
            content.innerHTML = text + '<br><button onclick="addFavorite(\'Surah ' + surahNum + '\')">Ajouter aux Favoris <span class="icon">‚≠ê</span></button>';
            content.classList.add('loaded');
            content.scrollIntoView({behavior: 'smooth'});
        }

        function searchText(query) {
            if (!query || !quranData) return;
            const content = document.getElementById('content');
            content.innerHTML = '';
            content.classList.remove('loaded');
            let results = '';
            quranData.data.surahs.forEach(surah => {
                surah.ayahs.forEach(ayah => {
                    if (ayah.text.includes(query)) {
                        results += `<div class="favorite" onclick="loadSurah(${surah.number})">${surahNames[surah.number]} Ayah ${ayah.numberInSurah}: ${ayah.text}</div>`;
                    }
                });
            });
            content.innerHTML = results || 'Aucun r√©sultat';
            content.classList.add('loaded');
        }

        function adjustFont(size) {
            document.getElementById('content').style.fontSize = `${size}px`;
        }

        function markDone(hizbNum) {
            if (!readHizbs.includes(hizbNum)) {
                readHizbs.push(hizbNum);
                localStorage.setItem('hizbsRead', JSON.stringify(readHizbs));
                updateProgress();
                renderSelects();
                document.getElementById('content').innerHTML = '';
            }
        }

        function unmarkDone(hizbNum) {
            readHizbs = readHizbs.filter(h => h !== hizbNum);
            localStorage.setItem('hizbsRead', JSON.stringify(readHizbs));
            updateProgress();
            renderSelects();
            document.getElementById('content').innerHTML = '';
        }

        function resetProgress() {
            if (confirm('R√©initialiser toute la progression ?')) {
                readHizbs = [];
                localStorage.setItem('hizbsRead', JSON.stringify(readHizbs));
                updateProgress();
                renderSelects();
                document.getElementById('content').innerHTML = '';
            }
        }

        function addFavorite(item) {
            if (!favorites.includes(item)) favorites.push(item);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderFavorites();
        }

        function renderFavorites() {
            const favDiv = document.getElementById('favorites');
            favDiv.innerHTML = '<h3>Favoris</h3>';
            favorites.forEach(fav => {
                const div = document.createElement('div');
                div.className = 'favorite';
                div.textContent = fav;
                div.onclick = () => {
                    if (fav.startsWith('Hizb')) loadHizb(parseInt(fav.split(' ')[1]));
                    else if (fav.startsWith('Surah')) loadSurah(parseInt(fav.split(' ')[1]));
                };
                favDiv.appendChild(div);
            });
        }

        function addToHistory(item) {
            history.unshift(item);
            if (history.length > 5) history.pop();
            localStorage.setItem('history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const histDiv = document.getElementById('history');
            histDiv.innerHTML = '<h3>Historique</h3>';
            history.forEach(hist => {
                const div = document.createElement('div');
                div.className = 'favorite';
                div.textContent = hist;
                div.onclick = () => {
                    if (hist.startsWith('Hizb')) loadHizb(parseInt(hist.split(' ')[1]));
                    else if (hist.startsWith('Surah')) loadSurah(parseInt(hist.split(' ')[1]));
                };
                histDiv.appendChild(div);
            });
        }

        loadQuran().then(() => {
            renderSelects();
            updateProgress();
            renderFavorites();
            renderHistory();
            adjustFont(22);
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            }
        });
    </script>
</body>
</html>
